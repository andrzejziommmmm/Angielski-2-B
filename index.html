<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KidsCan! 2 ‚Äî Trener s≈Ç√≥wek i tabliczki mno≈ºenia KLASA 2B</title>
  <style>
    :root{
      --bg:#fff8f0; --card:#ffffff; --ink:#1b1b1b; --muted:#666; --accent:#6c5ce7; --accent2:#00b894; --wrong:#ff7675; --right:#55efc4;
      --math-color: #6C63FF; --english-color: #FF6584;
    }
    html,body{height:100%;}
    body{margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", sans-serif; background:var(--bg); color:var(--ink);}
    .app{max-width:1100px; margin:0 auto; padding:16px 16px 28px;}
    .header{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .title{display:flex; align-items:center; gap:10px;}
    .title h1{margin:0; font-size:clamp(22px, 3vw, 32px);}
    .title .badge{background:var(--accent); color:white; padding:6px 10px; border-radius:999px; font-weight:700; font-size:14px;}
    
    .subject-selector{display:flex; gap:10px; margin:20px 0; justify-content:center;}
    .subject-btn{flex:1; max-width:200px; padding:14px; border-radius:16px; border:3px solid #eee; background:white; font-size:18px; font-weight:800; cursor:pointer; text-align:center; transition:all 0.3s;}
    .subject-btn.active{transform:translateY(-3px); box-shadow:0 5px 15px rgba(0,0,0,0.1);}
    .subject-btn.english.active{border-color:var(--english-color); background:#ffeef2;}
    .subject-btn.math.active{border-color:var(--math-color); background:#f0f0ff;}
    
    .panel{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media(min-width:900px){
      .panel{grid-template-columns: 340px 1fr;}
    }
    .card{background:var(--card); border-radius:18px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.06);}
    .section-title{font-weight:800; margin:4px 0 10px; font-size:18px;}
    .row{display:flex; flex-wrap:wrap; gap:8px;}
    .select, select{width:100%; padding:12px 14px; border-radius:12px; border:2px solid #eee; font-size:16px;}
    .chip{display:inline-flex; align-items:center; gap:8px; background:#f3f4f6; border:2px solid #e5e7eb; padding:10px 12px; border-radius:14px; cursor:pointer; user-select:none; font-weight:700;}
    .chip input{display:none}
    .chip.active{background:#eaf7ff; border-color:#b6e3ff}
    .mode{display:grid; grid-template-columns:repeat(2,1fr); gap:8px;}
    .mode .chip{justify-content:center}
    .btn{appearance:none; border:none; padding:14px 16px; font-weight:900; border-radius:16px; cursor:pointer; font-size:16px;}
    .btn-primary{background:var(--accent); color:white;}
    .btn-secondary{background:#ffeaa7;}
    .btn-ghost{background:#f3f4f6;}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .quiz{display:grid; gap:12px;}
    .prompt{font-size:clamp(22px,2.6vw,30px); font-weight:900;}
    .choices{display:grid; gap:8px; grid-template-columns:1fr;}
    @media(min-width:700px){.choices{grid-template-columns:repeat(2,1fr);} }
    .choice{padding:14px; border-radius:14px; border:2px solid #eee; background:white; font-size:18px; text-align:center; cursor:pointer;}
    .choice:hover{transform:translateY(-1px);}
    .choice.correct{border-color:var(--right); background:#ecfff9}
    .choice.wrong{border-color:var(--wrong); background:#fff1f1}
    .progress{display:flex; align-items:center; gap:8px; font-weight:700;}
    .bar{flex:1; height:10px; background:#eee; border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2));}
    .tiny{color:var(--muted); font-size:12px;}

    .flex{display:flex; gap:8px; align-items:center}

    .pill{border-radius:999px; background:#f3f4f6; padding:6px 10px; font-weight:800;}

    .flashcard{display:grid; place-items:center; height:240px; border-radius:18px; border:2px dashed #e5e7eb; background:white; cursor:pointer; perspective:1000px;}
    .flash-inner{position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform .5s ease; display:grid; place-items:center;}
    .flash-inner.flipped{transform:rotateY(180deg)}
    .face{position:absolute; inset:0; backface-visibility:hidden; display:grid; place-items:center; font-size:28px; font-weight:900; padding:18px;}
    .back{transform:rotateY(180deg)}

    .sound-btn{background:#e8f5ff; border-radius:999px; padding:10px 12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; font-weight:800;}

    .footer{margin-top:14px; color:#666; font-size:12px;}
    
    /* Styl dla matematyki - ZACHOWANE WSZYSTKIE EFEKTY WIZUALNE */
    .math-visualization {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 2rem 0;
      flex-wrap: wrap;
    }
    
    .multiply-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .group-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .math-element {
      width: 35px;
      height: 35px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      background: var(--math-color);
      color: white;
      animation: float 3s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .math-operator {
      font-size: 2rem;
      color: var(--math-color);
    }
    
    .result-display {
      font-size: 2.5rem;
      margin: 1rem 0;
      color: var(--math-color);
      min-height: 60px;
      text-shadow: 0 0 10px rgba(108, 99, 255, 0.5);
    }
    
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }
    
    .star {
      position: absolute;
      background-color: white;
      border-radius: 50%;
      animation: twinkle 5s infinite;
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    
    .cosmic-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.1;
      pointer-events: none;
    }
    
    .rocket {
      position: absolute;
      font-size: 3rem;
      animation: fly 15s linear infinite;
      z-index: 0;
    }
    
    @keyframes fly {
      0% { transform: translateX(-100px) translateY(100px) rotate(45deg); }
      100% { transform: translateX(1200px) translateY(-800px) rotate(45deg); }
    }
    
    .alien {
      position: absolute;
      font-size: 2rem;
      animation: floatAlien 8s ease-in-out infinite;
      z-index: 0;
    }
    
    @keyframes floatAlien {
      0%, 100% { transform: translateY(0) rotate(0); }
      25% { transform: translateY(-20px) rotate(5deg); }
      50% { transform: translateY(0) rotate(0); }
      75% { transform: translateY(20px) rotate(-5deg); }
    }
    
    .ufo {
      position: absolute;
      font-size: 2.5rem;
      animation: hoverUFO 10s ease-in-out infinite;
      z-index: 0;
    }
    
    @keyframes hoverUFO {
      0%, 100% { transform: translateX(0) translateY(0); }
      25% { transform: translateX(50px) translateY(-30px); }
      50% { transform: translateX(0) translateY(-50px); }
      75% { transform: translateX(-50px) translateY(-30px); }
    }
    
    .celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 20px;
      background: var(--accent);
      top: -20px;
      animation: fall 5s linear forwards;
    }
    
    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
      }
    }
    
    .multiply-table {
      display: grid;
      grid-template-columns: repeat(11, 1fr);
      gap: 5px;
      margin-top: 1rem;
    }
    
    .table-cell {
      padding: 10px 5px;
      text-align: center;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .table-cell.header {
      background: rgba(108, 99, 255, 0.3);
      font-weight: bold;
    }
    
    .table-cell.highlight {
      background: rgba(54, 209, 220, 0.3);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .hidden {
      display: none;
    }

    /* Styl dla misji matematycznych - ZACHOWANE Z POPRZEDNIEJ APLIKACJI */
    .mission-selector {
      background: rgba(42, 45, 67, 0.7);
      border-radius: 20px;
      padding: 2rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(108, 99, 255, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .mission-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #36D1DC;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .mission-title::before {
      content: "üöÄ";
    }
    
    .planet-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 1.5rem;
    }
    
    .planet {
      aspect-ratio: 1;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      padding: 1rem;
      text-align: center;
    }
    
    .planet-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .planet-name {
      font-size: 1rem;
      margin-bottom: 5px;
    }
    
    .planet-desc {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    
    .planet::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .planet:hover::before {
      opacity: 1;
    }
    
    .planet.active {
      transform: scale(1.05);
      box-shadow: 0 0 25px currentColor;
    }
    
    .math-game-area {
      background: rgba(42, 45, 67, 0.7);
      border-radius: 20px;
      padding: 2rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(108, 99, 255, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 500px;
      position: relative;
      overflow: hidden;
    }
    
    .math-game-screen {
      width: 100%;
      text-align: center;
      z-index: 1;
    }
    
    .story-text {
      font-size: 1.2rem;
      line-height: 1.6;
      margin: 1.5rem 0;
      background: rgba(0, 0, 0, 0.3);
      padding: 1.5rem;
      border-radius: 15px;
      border-left: 4px solid #36D1DC;
    }
    
    .math-answer-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 2rem 0;
      width: 100%;
      max-width: 400px;
    }
    
    .math-controls {
      display: flex;
      gap: 15px;
      margin-top: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .math-progress-container {
      margin-top: 2rem;
      width: 100%;
    }
    
    .math-progress-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .math-progress {
      height: 100%;
      background: linear-gradient(90deg, #6C63FF, #36D1DC);
      border-radius: 5px;
      transition: width 0.5s ease;
      width: 0%;
    }
    
    .math-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #A0A3BD;
    }
    
    .math-achievements {
      display: flex;
      gap: 15px;
      margin-top: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .math-achievement {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255, 101, 132, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .math-achievement.unlocked {
      border-color: #FF6584;
      background: rgba(255, 101, 132, 0.4);
      transform: scale(1.1);
      animation: glow 2s infinite;
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px #FF6584; }
      50% { box-shadow: 0 0 20px #FF6584; }
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>
  <div class="cosmic-bg" id="cosmic-bg"></div>
  <div class="celebration" id="celebration"></div>
  
  <div class="app">
    <div class="header">
      <div class="title">
         <h1>Klasa 2B  Trener s≈Ç√≥wek i tabliczki mno≈ºenia</h1>
      </div>
    </div>
    
    <div class="subject-selector">
      <button class="subject-btn english active" data-subject="english">üá¨üáß Angielski</button>
      <button class="subject-btn math" data-subject="math">üî¢ Matematyka</button>
    </div>

    <!-- Widok Angielski -->
    <div id="englishView" class="panel">
      <aside class="card">
        <div class="section-title">1) Wybierz rozdzia≈Ç</div>
        <select id="chapterSelect" class="select"></select>

        <div class="section-title">2) Zakres s≈Çownictwa</div>
        <div class="row" id="scopeRow">
          <label class="chip"><input type="radio" name="scope" value="basic" checked/> Podstawowe üå±</label>
          <label class="chip"><input type="radio" name="scope" value="extended"/> Rozszerzone üåø</label>
          <label class="chip"><input type="radio" name="scope" value="both"/> Oba ‚úÖ</label>
        </div>

        <div class="section-title">3) Tryb nauki</div>
        <div class="mode" id="modeRow">
          <label class="chip"><input type="radio" name="mode" value="en2pl"/> EN ‚Üí PL</label>
          <label class="chip"><input type="radio" name="mode" value="pl2en"/> PL ‚Üí EN</label>
          <label class="chip"><input type="radio" name="mode" value="spelling"/> Pisownia (EN ‚úçÔ∏è)</label>
          <label class="chip active"><input type="radio" name="mode" value="mix" checked/> MIX (domy≈õlnie)</label>
        </div>

        <div class="section-title">4) Dodatkowe opcje</div>
        <div class="row">
          <button class="btn btn-ghost" id="btnTTSen" title="Ods≈Çuchaj po angielsku">üîä EN</button>
          <button class="btn btn-ghost" id="btnTTSpl" title="Ods≈Çuchaj po polsku">üîä PL</button>
          <button class="btn btn-secondary" id="btnFlash">üÉè Tryb fiszek</button>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn btn-primary" id="btnStart">‚ñ∂Ô∏è Start testu</button>
          <button class="btn" id="btnReset">üîÑ Reset</button>
        </div>
      </aside>

      <main class="card">
        <div id="quizView" class="quiz">
          <div class="progress"><div class="bar"><i id="barFill"></i></div><span id="counter">0/0</span></div>
          <div class="prompt" id="prompt">Wybierz rozdzia≈Ç i kliknij Start testu.</div>
          <div class="row">
            <span class="sound-btn" id="speakPrompt">üîä Przeczytaj</span>
          </div>
          <div id="choices" class="choices"></div>
          <div id="spellingBox" style="display:none" class="row">
            <input id="spellingInput" class="select" placeholder="Wpisz po angielsku‚Ä¶"/>
            <button class="btn btn-primary" id="checkSpell">Sprawd≈∫</button>
          </div>
          <div class="row">
            <button class="btn btn-secondary" id="btnNext" disabled>Nastƒôpne ‚û°Ô∏è</button>
          </div>
          <div class="tiny" id="feedback"></div>
        </div>

        <div id="flashView" style="display:none">
          <div class="progress"><div class="bar"><i id="barFillFlash"></i></div><span id="counterFlash">0/0</span></div>
          <div class="flashcard" id="flashcard" title="Kliknij, aby obr√≥ciƒá">
            <div class="flash-inner" id="flashInner">
              <div class="face front" id="flashFront">üò∫</div>
              <div class="face back" id="flashBack">‚Äî</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn btn-ghost" id="speakFront">üîä Prz√≥d</button>
            <button class="btn btn-ghost" id="speakBack">üîä Ty≈Ç</button>
            <button class="btn btn-secondary" id="markHard">üôà Jeszcze</button>
            <button class="btn btn-primary" id="markEasy">üò∫ Umiem</button>
          </div>
        </div>
      </main>
    </div>

    <!-- Widok Matematyka - ZACHOWANE WSZYSTKIE EFEKTY WIZUALNE -->
    <div id="mathView" class="panel" style="display:none">
      <aside class="mission-selector">
        <h2 class="mission-title">Wybierz Misjƒô</h2>
        <div class="planet-grid" id="planet-grid"></div>
        
        <div class="math-progress-container">
          <div class="math-progress-bar">
            <div class="math-progress" id="math-progress-bar"></div>
          </div>
          <div class="math-stats">
            <span>Poziom: <span id="math-level">1</span></span>
            <span>Punkty: <span id="math-points">0</span></span>
            <span>Energia: <span id="math-energy">100</span>%</span>
          </div>
        </div>
        
        <div class="math-achievements" id="math-achievements"></div>
      </aside>
      
      <main class="math-game-area">
        <div class="math-game-screen" id="math-game-screen">
          <h2 id="math-game-title">Wyb√≥r Trybu Misji</h2>
          <p id="math-game-description">Wybierz misjƒô z panelu po lewej, aby rozpoczƒÖƒá kosmicznƒÖ przygodƒô z mno≈ºeniem!</p>
          
          <div class="math-visualization" id="math-visualization"></div>
          
          <div class="result-display" id="math-result-display"></div>
          
          <div class="story-text hidden" id="math-story-text"></div>
          
          <div class="math-answer-options" id="math-answer-options"></div>
          
          <div class="math-controls">
            <button class="btn" id="math-hint-btn">Podpowied≈∫</button>
            <button class="btn btn-secondary" id="math-next-btn">Dalej</button>
            <button class="btn" id="math-reset-btn">Reset</button>
          </div>
        </div>
        
        <div class="multiply-table hidden" id="math-multiply-table"></div>
      </main>
    </div>

    <div class="footer">Andrzej & Marcin Dane s≈Çownictwa na podstawie planu ‚ÄûKids Can! 2‚Äù (rozdzia≈Çy i zakres podstawowy/rozszerzony). Projekt edukacyjny ‚Äî u≈ºytek w≈Çasny w klasie/szkole.</div>
  </div>

<script>
// === KOSMICZNE T≈ÅO ===
function createStars() {
  const starsContainer = document.getElementById('stars');
  const starCount = 150;
  
  for (let i = 0; i < starCount; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    
    const size = Math.random() * 3;
    star.style.width = `${size}px`;
    star.style.height = `${size}px`;
    star.style.left = `${Math.random() * 100}%`;
    star.style.top = `${Math.random() * 100}%`;
    star.style.animationDelay = `${Math.random() * 5}s`;
    
    starsContainer.appendChild(star);
  }
}

function createCosmicBackground() {
  const cosmicBg = document.getElementById('cosmic-bg');
  
  for (let i = 0; i < 3; i++) {
    const rocket = document.createElement('div');
    rocket.className = 'rocket';
    rocket.innerHTML = 'üöÄ';
    rocket.style.left = `${Math.random() * 100}%`;
    rocket.style.top = `${Math.random() * 100}%`;
    rocket.style.animationDelay = `${Math.random() * 5}s`;
    cosmicBg.appendChild(rocket);
  }
  
  for (let i = 0; i < 4; i++) {
    const alien = document.createElement('div');
    alien.className = 'alien';
    alien.innerHTML = 'üëΩ';
    alien.style.left = `${Math.random() * 100}%`;
    alien.style.top = `${Math.random() * 100}%`;
    alien.style.animationDelay = `${Math.random() * 8}s`;
    cosmicBg.appendChild(alien);
  }
  
  for (let i = 0; i < 2; i++) {
    const ufo = document.createElement('div');
    ufo.className = 'ufo';
    ufo.innerHTML = 'üõ∏';
    ufo.style.left = `${Math.random() * 100}%`;
    ufo.style.top = `${Math.random() * 100}%`;
    ufo.style.animationDelay = `${Math.random() * 10}s`;
    cosmicBg.appendChild(ufo);
  }
}

// === PRZE≈ÅƒÑCZANIE MIƒòDZY PRZEDMIOTAMI ===
document.querySelectorAll('.subject-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    
    const subject = this.dataset.subject;
    document.getElementById('englishView').style.display = subject === 'english' ? 'grid' : 'none';
    document.getElementById('mathView').style.display = subject === 'math' ? 'grid' : 'none';
  });
});

// === CZƒò≈öƒÜ ANGIELSKA ===

// === Dane s≈Çownictwa ‚Äî ROZDZIA≈ÅY ===
const DATA = {
  "Wstƒôpny": {
    basic: [
      {en:"alphabet", pl:"alfabet"}, {en:"count to 20", pl:"liczyƒá do 20"},
      {en:"days of the week", pl:"dni tygodnia"},
      {en:"cloudy", pl:"pochmurno"}, {en:"cold", pl:"zimno"}, {en:"hot", pl:"gorƒÖco"}, {en:"rainy", pl:"deszczowo"}, {en:"sunny", pl:"s≈Çonecznie"}, {en:"windy", pl:"wietrznie"}
    ],
    extended: [
      {en:"What's your name?", pl:"Jak masz na imiƒô?"}, {en:"How old are you?", pl:"Ile masz lat?"},
      {en:"My favourite day is‚Ä¶", pl:"M√≥j ulubiony dzie≈Ñ to‚Ä¶"}
    ]
  },
  "1. School": {
    basic: [
      {en:"classroom", pl:"klasa"}, {en:"computer room", pl:"pracownia komputerowa"}, {en:"corridor", pl:"korytarz"}, {en:"dining room", pl:"sto≈Ç√≥wka"}, {en:"gym", pl:"sala gimnastyczna"}, {en:"library", pl:"biblioteka"}, {en:"playground", pl:"plac zabaw"}, {en:"toilet", pl:"toaleta"},
      {en:"behind", pl:"za"}, {en:"between", pl:"miƒôdzy"}, {en:"in front of", pl:"przed"}, {en:"next to", pl:"obok"}
    ],
    extended: [
      {en:"line up", pl:"ustaw siƒô w kolejce"}, {en:"listen to others", pl:"s≈Çuchaj innych"}, {en:"play nicely", pl:"baw siƒô ≈Çadnie"}, {en:"put your hand up", pl:"podnie≈õ rƒôkƒô"}, {en:"wash your hands", pl:"umyj rƒôce"},
      {en:"catch", pl:"≈Çapaƒá / berek"}, {en:"hide-and-seek", pl:"chowanego"}, {en:"hopscotch", pl:"klasy"}, {en:"monster tag", pl:"potworny berek"},
      {en:"glue", pl:"klej"}, {en:"markers", pl:"pisaki"}, {en:"paints", pl:"farby"}, {en:"plasticine", pl:"plastelina"}, {en:"scissors", pl:"no≈ºyczki"}, {en:"sticky tape", pl:"ta≈õma klejƒÖca"}
    ]
  },
  "2. House": {
    basic: [
      {en:"attic", pl:"strych"}, {en:"bathroom", pl:"≈Çazienka"}, {en:"bedroom", pl:"sypialnia"}, {en:"garage", pl:"gara≈º"}, {en:"garden", pl:"ogr√≥d"}, {en:"hall", pl:"hol/przedpok√≥j"}, {en:"kitchen", pl:"kuchnia"}, {en:"living room", pl:"salon"},
      {en:"flat", pl:"mieszkanie"}, {en:"house", pl:"dom"},
      {en:"bed", pl:"≈Ç√≥≈ºko"}, {en:"cooker", pl:"kuchenka"}, {en:"fridge", pl:"lod√≥wka"}, {en:"shower", pl:"prysznic"}, {en:"sofa", pl:"sofa"}
    ],
    extended: [
      {en:"fabric", pl:"tkanina"}, {en:"metal", pl:"metal"}, {en:"stone", pl:"kamie≈Ñ"}, {en:"straw", pl:"s≈Çoma"}, {en:"wood", pl:"drewno"},
      {en:"caravan", pl:"przyczepa kempingowa"}, {en:"castle", pl:"zamek"}, {en:"cottage", pl:"chatka"}, {en:"houseboat", pl:"barka mieszkalna"},
      {en:"armchair", pl:"fotel"}, {en:"bath", pl:"wanna"}, {en:"bookshelf", pl:"rega≈Ç na ksiƒÖ≈ºki"}, {en:"carpet", pl:"dywan"}, {en:"drawer", pl:"szuflada"}, {en:"table", pl:"st√≥≈Ç"}
    ]
  },
  "3. Clothes": {
    basic: [
      {en:"dress", pl:"sukienka"}, {en:"jacket", pl:"kurtka"}, {en:"jeans", pl:"d≈ºinsy"}, {en:"skirt", pl:"sp√≥dnica"}, {en:"sweater", pl:"sweter"}, {en:"trainers", pl:"trampki"}, {en:"trousers", pl:"spodnie"}, {en:"T-shirt", pl:"koszulka"},
      {en:"clean", pl:"czysty"}, {en:"dirty", pl:"brudny"}, {en:"new", pl:"nowy"}, {en:"old", pl:"stary"}
    ],
    extended: [
      {en:"sunhat", pl:"kapelusz przeciws≈Çoneczny"}, {en:"apron", pl:"fartuch"}, {en:"P.E. kit", pl:"str√≥j na WF"}, {en:"sweatshirt", pl:"bluza"}, {en:"school uniform", pl:"mundurek"},
      {en:"hoodie", pl:"bluza z kapturem"}, {en:"shorts", pl:"kr√≥tkie spodenki"}, {en:"socks", pl:"skarpetki"}, {en:"swimsuit", pl:"str√≥j kƒÖpielowy"}, {en:"vest", pl:"podkoszulek"}, {en:"wellies", pl:"kalosze"}
    ]
  },
  "4. Appearance": {
    basic: [
      {en:"beard", pl:"broda"}, {en:"curly hair", pl:"krƒôcone w≈Çosy"}, {en:"dark hair", pl:"ciemne w≈Çosy"}, {en:"fair hair", pl:"jasne w≈Çosy"}, {en:"long hair", pl:"d≈Çugie w≈Çosy"}, {en:"moustache", pl:"wƒÖsy"}, {en:"short hair", pl:"kr√≥tkie w≈Çosy"}, {en:"straight hair", pl:"proste w≈Çosy"},
      {en:"crown", pl:"korona"}, {en:"earrings", pl:"kolczyki"}, {en:"glasses", pl:"okulary"}, {en:"necklace", pl:"naszyjnik"}, {en:"wig", pl:"peruka"},
      {en:"circle", pl:"ko≈Ço"}, {en:"line", pl:"linia"}, {en:"oval", pl:"owal"}
    ],
    extended: [
      {en:"birthday party", pl:"urodziny"}, {en:"carnival", pl:"karnawa≈Ç"}, {en:"Halloween", pl:"Halloween"}, {en:"school play", pl:"przedstawienie szkolne"},
      {en:"cook", pl:"kucharz"}, {en:"dancer", pl:"tancerz"}, {en:"driver", pl:"kierowca"}, {en:"painter", pl:"malarz"}, {en:"police officer", pl:"policjant"}, {en:"vet", pl:"weterynarz"}
    ]
  },
  "5. Camp & Free time": {
    basic: [
      {en:"climb a tree", pl:"wspinaƒá siƒô na drzewo"}, {en:"do yoga", pl:"ƒáwiczyƒá jogƒô"}, {en:"go for a walk", pl:"i≈õƒá na spacer"}, {en:"play basketball", pl:"graƒá w koszyk√≥wkƒô"}, {en:"play table tennis", pl:"graƒá w tenisa sto≈Çowego"}, {en:"play volleyball", pl:"graƒá w siatk√≥wkƒô"}, {en:"sail a boat", pl:"p≈ÇynƒÖƒá ≈Ç√≥dkƒÖ/≈ºeglowaƒá"}, {en:"swim in the lake", pl:"p≈Çywaƒá w jeziorze"},
      {en:"make a model", pl:"sk≈Çadaƒá model"}, {en:"play a board game", pl:"graƒá w grƒô planszowƒÖ"}, {en:"play the guitar", pl:"graƒá na gitarze"}, {en:"read a comic", pl:"czytaƒá komiks"}
    ],
    extended: [
      {en:"bones", pl:"ko≈õci"}, {en:"joints", pl:"stawy"}, {en:"muscles", pl:"miƒô≈õnie"}, {en:"skeleton", pl:"szkielet"},
      {en:"cook on a campfire", pl:"gotowaƒá na ognisku"}, {en:"make a den", pl:"zbudowaƒá bazƒô/sza≈Ças"}, {en:"sing songs", pl:"≈õpiewaƒá piosenki"}, {en:"tell scary stories", pl:"opowiadaƒá straszne historie"},
      {en:"have a picnic", pl:"mieƒá piknik"}, {en:"go kayaking", pl:"p≈Çywaƒá kajakiem"}, {en:"listen to music", pl:"s≈Çuchaƒá muzyki"}, {en:"play cards", pl:"graƒá w karty"}, {en:"sleep in a tent", pl:"spaƒá w namiocie"}, {en:"take photos", pl:"robiƒá zdjƒôcia"}
    ]
  },
  "6. Summer & City": {
    basic: [
      {en:"aquarium", pl:"akwarium"}, {en:"beach", pl:"pla≈ºa"}, {en:"funfair", pl:"weso≈Çe miasteczko"}, {en:"mountains", pl:"g√≥ry"}, {en:"safari park", pl:"park safari"}, {en:"skate park", pl:"skatepark"}, {en:"village", pl:"wie≈õ"}, {en:"water park", pl:"aquapark"},
      {en:"by boat", pl:"≈ÇodziƒÖ"}, {en:"by bus", pl:"autobusem"}, {en:"by car", pl:"samochodem"}, {en:"by train", pl:"pociƒÖgiem"}, {en:"on foot", pl:"pieszo"}
    ],
    extended: [
      {en:"by bike", pl:"rowerem"}, {en:"by ferry", pl:"promem"}, {en:"by underground train", pl:"metrem"},
      {en:"do crafts", pl:"robiƒá prace plastyczne"}, {en:"dress up", pl:"przebieraƒá siƒô"}, {en:"play in the playground", pl:"bawiƒá siƒô na placu zabaw"}, {en:"visit a castle", pl:"zwiedzaƒá zamek"},
      {en:"bakery", pl:"piekarnia"}, {en:"bookshop", pl:"ksiƒôgarnia"}, {en:"clothes shop", pl:"sklep z ubraniami"}, {en:"greengrocer's", pl:"warzywniak"}, {en:"pet shop", pl:"sklep zoologiczny"}, {en:"toy shop", pl:"sklep z zabawkami"}
    ]
  }
};

// === Stan aplikacji angielskiej ===
let queue = []; // kolejka pyta≈Ñ
let current = null; // bie≈ºƒÖce pytanie {q, a, item}
let answered = 0, correct = 0;
let wrongStack = []; // b≈Çƒôdne odpowiedzi do powt√≥rki
let mode = 'mix';
let flashIndex = 0; let flashItems = [];

// === Inicjalizacja angielska ===
const chapterSelect = document.getElementById('chapterSelect');
Object.keys(DATA).forEach((name, idx)=>{
  const opt = document.createElement('option');
  opt.value = name; opt.textContent = name; if(idx===0) opt.selected=true; chapterSelect.appendChild(opt);
});

// radio chips UI
function syncChips(containerId){
  const el = document.getElementById(containerId);
  el.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      el.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      const input = ch.querySelector('input'); input.checked = true;
      if(containerId==='modeRow'){ mode = input.value; document.getElementById('spellingBox').style.display = (mode==='spelling')?'grid':'none'; }
    });
  });
}

syncChips('scopeRow');
syncChips('modeRow');

// === TTS - POPRAWIONY LEKTOR ANGIELSKI ===
let voiceEN = null;
let voicePL = null;

function initVoices() {
  const voices = window.speechSynthesis.getVoices();
  
  // Poprawiony wyb√≥r lektora angielskiego - preferujemy brytyjski akcent
  voiceEN =
    voices.find(v => v.lang.startsWith('en-GB') && v.localService) || // Preferuj brytyjski
    voices.find(v => v.lang.startsWith('en-US') && v.localService) ||  // Ameryka≈Ñski jako druga opcja
    voices.find(v => v.lang.toLowerCase().includes('en') && v.localService) || // Jakikolwiek angielski
    voices.find(v => v.lang.startsWith('en-GB')) || // Bez localService
    voices.find(v => v.lang.startsWith('en-US')) ||
    voices.find(v => v.lang.toLowerCase().includes('en')) ||
    voices[0];
  
  // Polski lektor
  voicePL =
    voices.find(v => v.lang.startsWith('pl-') && v.localService) ||
    voices.find(v => v.lang.toLowerCase().includes('pol') && v.localService) ||
    voices.find(v => v.lang.startsWith('pl-')) ||
    voices.find(v => v.lang.toLowerCase().includes('pol')) ||
    voices[0];
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = initVoices;
  initVoices();
}

function speakEN(text) {
  if (!voiceEN) initVoices();
  const u = new SpeechSynthesisUtterance(text);
  u.voice = voiceEN;
  u.rate = 0.9; // Wolniejsze tempo dla lepszego zrozumienia
  u.pitch = 1.0;
  u.volume = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function speakPL(text) {
  if (!voicePL) initVoices();
  const u = new SpeechSynthesisUtterance(text);
  u.voice = voicePL;
  u.rate = 0.9;
  u.pitch = 1.0;
  u.volume = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

// przyciski ods≈Çuchu
document.getElementById('btnTTSen').onclick = () =>
  current ? speakEN(current.qLang === 'en' ? current.q : current.a) : null;
document.getElementById('btnTTSpl').onclick = () =>
  current ? speakPL(current.qLang === 'en' ? current.a : current.q) : null;
document.getElementById('speakPrompt').onclick = () =>
  current ? (current.qLang === 'en' ? speakEN(current.q) : speakPL(current.q)) : null;

// === Losowanie pyta≈Ñ angielskich ===
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

function buildPool(){
  const chapter = chapterSelect.value;
  const scope = document.querySelector('input[name="scope"]:checked').value; // basic|extended|both
  let pool = [];
  const src = DATA[chapter];
  if(!src) return [];
  if(scope==='basic' || scope==='both') pool = pool.concat(src.basic);
  if(scope==='extended' || scope==='both') pool = pool.concat(src.extended);
  return pool;
}

function makeQuestion(item){
  // Based on mode, generate: {q,a,choices[], qLang:'en'|'pl'}
  const m = mode==='mix' ? ['en2pl','pl2en','spelling'][Math.floor(Math.random()*3)] : mode;
  const pool = buildPool();
  if(m==='spelling'){
    return {q:item.en, a:item.en, qLang:'en', type:'spelling', item};
  }
  if(m==='en2pl'){
    const distractors = shuffle(pool.filter(x=>x!==item)).slice(0,3).map(x=>x.pl);
    return {q:item.en, a:item.pl, qLang:'en', type:'choice', choices:shuffle([item.pl, ...distractors]), item};
  } else {
    const distractors = shuffle(pool.filter(x=>x!==item)).slice(0,3).map(x=>x.en);
    return {q:item.pl, a:item.en, qLang:'pl', type:'choice', choices:shuffle([item.en, ...distractors]), item};
  }
}

function startQuiz(){
  queue = shuffle(buildPool().slice());
  answered = 0; correct = 0; wrongStack = [];
  document.getElementById('feedback').textContent='';
  nextQuestion();
}

function nextQuestion(){
  document.getElementById('btnNext').disabled = true;
  document.getElementById('spellingInput').value='';
  const progressBar = document.getElementById('barFill');
  const counter = document.getElementById('counter');
  if(queue.length===0){
    if(wrongStack.length){ // powt√≥rka
      queue = shuffle(wrongStack.slice()); wrongStack = [];
      document.getElementById('feedback').innerHTML = 'üîÅ Powt√≥rka z b≈Çƒôd√≥w! Dobra robota, dzia≈Çamy dalej.';
    } else {
      document.getElementById('prompt').textContent = `Koniec! ‚úÖ Poprawnych: ${correct}`;
      document.getElementById('choices').innerHTML='';
      document.getElementById('spellingBox').style.display = (mode==='spelling')?'grid':'none';
      progressBar.style.width = '100%'; counter.textContent = '‚úîÔ∏è';
      current = null; return;
    }
  }
  const item = queue.shift();
  current = makeQuestion(item);
  renderQuestion(current);
  progressBar.style.width = `${(answered/(answered+queue.length+wrongStack.length))*100}%`;
  counter.textContent = `${answered}/${answered+queue.length+wrongStack.length}`;
}

function renderQuestion(q){
  const prompt = document.getElementById('prompt');
  const choices = document.getElementById('choices');
  const sb = document.getElementById('spellingBox');
  const feedback = document.getElementById('feedback');
  feedback.textContent = '';

  if(q.type==='choice'){
    sb.style.display = 'none';
    choices.innerHTML = '';
    prompt.textContent = q.q;
    q.choices.forEach(txt=>{
      const btn = document.createElement('button');
      btn.className = 'choice'; btn.textContent = txt;
      btn.onclick = ()=> selectChoice(btn, txt===q.a);
      choices.appendChild(btn);
    });
  } else { // spelling
    choices.innerHTML = '';
    sb.style.display = 'grid';
    prompt.textContent = `Napisz po angielsku: ${q.item.pl}`;
  }
}

function selectChoice(el, ok){
  const all = Array.from(document.querySelectorAll('.choice'));
  all.forEach(b=>b.disabled=true);
  el.classList.add(ok?'correct':'wrong');
  if(!ok){
    // zaznacz poprawnƒÖ
    const correctBtn = all.find(b=>b.textContent===current.a);
    if(correctBtn) correctBtn.classList.add('correct');
    wrongStack.push(current.item);
  } else {
    correct++;
  }
  answered++;
  document.getElementById('btnNext').disabled = false;
}

// Spelling check
function norm(s){ return s.trim().toLowerCase().replace(/\s+/g,' '); }
function checkSpelling(){
  const val = document.getElementById('spellingInput').value;
  const fb = document.getElementById('feedback');
  if(!val) return;
  const ok = norm(val)===norm(current.a);
  if(ok){ fb.textContent = '‚úÖ Super!'; correct++; } else { fb.textContent = `‚ùå Powinno byƒá: "${current.a}"`; wrongStack.push(current.item); }
  answered++; document.getElementById('btnNext').disabled = false;
}

document.getElementById('checkSpell').onclick = checkSpelling;
document.getElementById('spellingInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ checkSpelling(); }});

document.getElementById('btnNext').onclick = nextQuestion;
document.getElementById('btnStart').onclick = startQuiz;
document.getElementById('btnReset').onclick = ()=>{ queue=[]; wrongStack=[]; answered=0; correct=0; current=null; document.getElementById('prompt').textContent='Wybierz rozdzia≈Ç i kliknij Start testu.'; document.getElementById('choices').innerHTML=''; document.getElementById('counter').textContent='0/0'; document.getElementById('barFill').style.width='0%'; };

// === Tryb fiszek angielski ===
const flashView = document.getElementById('flashView');
const quizView = document.getElementById('quizView');

document.getElementById('btnFlash').onclick = ()=>{
  if(flashView.style.display==='none'){ enterFlash(); } else { exitFlash(); }
};

function enterFlash(){
  flashItems = shuffle(buildPool().slice());
  flashIndex = 0; renderFlash();
  quizView.style.display='none'; flashView.style.display='block';
}
function exitFlash(){ quizView.style.display='grid'; flashView.style.display='none'; }

function renderFlash(){
  const total = flashItems.length; const cur = flashItems[flashIndex] || {en:'‚Äî', pl:'‚Äî'};
  document.getElementById('flashFront').textContent = cur.en;
  document.getElementById('flashBack').textContent = cur.pl;
  document.getElementById('barFillFlash').style.width = `${(flashIndex/Math.max(1,total))*100}%`;
  document.getElementById('counterFlash').textContent = `${flashIndex+1}/${total}`;
  document.getElementById('flashInner').classList.remove('flipped');
}

document.getElementById('flashcard').onclick = ()=>{
  document.getElementById('flashInner').classList.toggle('flipped');
};

document.getElementById('markEasy').onclick = ()=>{ if(flashIndex < flashItems.length-1){ flashIndex++; renderFlash(); } };

document.getElementById('markHard').onclick = ()=>{
  // Do≈Ç√≥≈º bie≈ºƒÖcƒÖ fiszkƒô na koniec talijki, ≈ºeby wr√≥ci≈Ça
  const it = flashItems[flashIndex]; flashItems.push(it);
  flashIndex++; renderFlash();
};

document.getElementById('speakFront').onclick = ()=>{ const it=flashItems[flashIndex]; speakEN(it.en); };

document.getElementById('speakBack').onclick = ()=>{ const it=flashItems[flashIndex]; speakPL(it.pl); };

// === CZƒò≈öƒÜ MATEMATYCZNA - ZACHOWANE WSZYSTKIE EFEKTY WIZUALNE ===

// G≈Ç√≥wny stan aplikacji matematycznej
const mathState = {
  currentPlanet: null,
  level: 1,
  points: 0,
  streak: 0,
  achievements: [],
  currentQuestion: null,
  correctAnswers: 0,
  totalQuestions: 0,
  energy: 100
};

// Inicjalizacja matematyki
function generatePlanets() {
  const planetGrid = document.getElementById('planet-grid');
  const planets = [
    { 
      id: 'visual', 
      name: 'Wizualizacja', 
      color: '#6C63FF', 
      icon: 'üëÅÔ∏è',
      description: 'Zobacz mno≈ºenie w akcji'
    },
    { 
      id: 'practice', 
      name: 'Trening', 
      color: '#FF6584', 
      icon: 'üí™',
      description: 'ƒÜwicz w r√≥≈ºnych konfiguracjach'
    },
    { 
      id: 'challenge', 
      name: 'Wyzwanie', 
      color: '#36D1DC', 
      icon: 'üèÜ',
      description: 'Sprawd≈∫ swojƒÖ szybko≈õƒá'
    },
    { 
      id: 'table', 
      name: 'Tabela', 
      color: '#FF9800', 
      icon: 'üìä',
      description: 'Eksploruj ca≈ÇƒÖ tabliczkƒô'
    },
    { 
      id: 'story', 
      name: 'Opowie≈õƒá', 
      color: '#4CAF50', 
      icon: 'üìñ',
      description: 'Kosmiczne historie z mno≈ºeniem'
    }
  ];
  
  planets.forEach(planet => {
    const planetEl = document.createElement('div');
    planetEl.className = 'planet';
    planetEl.style.background = `radial-gradient(circle at 30% 30%, ${planet.color}, ${darkenColor(planet.color, 30)})`;
    planetEl.style.border = `2px solid ${planet.color}`;
    planetEl.innerHTML = `
      <div class="planet-icon">${planet.icon}</div>
      <div class="planet-name">${planet.name}</div>
      <div class="planet-desc">${planet.description}</div>
    `;
    
    planetEl.addEventListener('click', () => selectMathPlanet(planet));
    
    planetGrid.appendChild(planetEl);
  });
}

function generateMathAchievements() {
  const achievementsContainer = document.getElementById('math-achievements');
  const achievements = [
    { id: 'first', icon: '‚≠ê', requirement: 5, name: 'Pierwsze kroki' },
    { id: 'streak', icon: 'üî•', requirement: 10, name: 'P≈Çomie≈Ñ' },
    { id: 'master', icon: 'üëë', requirement: 50, name: 'Kr√≥l mno≈ºenia' },
    { id: 'genius', icon: 'üß†', requirement: 100, name: 'Geniusz' }
  ];
  
  achievements.forEach(ach => {
    const achEl = document.createElement('div');
    achEl.className = 'math-achievement';
    achEl.id = `math-ach-${ach.id}`;
    achEl.innerHTML = ach.icon;
    achEl.title = `${ach.name} - ${ach.requirement} poprawnych odpowiedzi`;
    
    achievementsContainer.appendChild(achEl);
  });
}

function generateMultiplyTable() {
  const tableContainer = document.getElementById('math-multiply-table');
  tableContainer.innerHTML = '';
  
  // Nag≈Ç√≥wek
  for (let i = 0; i <= 10; i++) {
    const headerCell = document.createElement('div');
    headerCell.className = 'table-cell header';
    headerCell.textContent = i === 0 ? '√ó' : i;
    tableContainer.appendChild(headerCell);
  }
  
  // Wiersze
  for (let i = 1; i <= 10; i++) {
    const headerCell = document.createElement('div');
    headerCell.className = 'table-cell header';
    headerCell.textContent = i;
    tableContainer.appendChild(headerCell);
    
    for (let j = 1; j <= 10; j++) {
      const cell = document.createElement('div');
      cell.className = 'table-cell';
      cell.textContent = i * j;
      cell.dataset.row = i;
      cell.dataset.col = j;
      tableContainer.appendChild(cell);
    }
  }
}

// Wyb√≥r planety/misji matematycznej
function selectMathPlanet(planet) {
  // Resetowanie poprzedniego wyboru
  document.querySelectorAll('.planet').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  
  mathState.currentPlanet = planet.id;
  
  // Ukrycie tabliczki mno≈ºenia je≈õli by≈Ça widoczna
  document.getElementById('math-multiply-table').classList.add('hidden');
  document.getElementById('math-game-screen').classList.remove('hidden');
  document.getElementById('math-story-text').classList.add('hidden');
  
  switch(planet.id) {
    case 'visual':
      startVisualMathMode();
      break;
    case 'practice':
      startPracticeMathMode();
      break;
    case 'challenge':
      startChallengeMathMode();
      break;
    case 'table':
      showMathMultiplyTable();
      break;
    case 'story':
      startStoryMathMode();
      break;
  }
}

// Tryb wizualizacji matematycznej
function startVisualMathMode() {
  showMathMessage(
    "Misja Wizualizacji", 
    "Zobacz mno≈ºenie jako grupy kosmicznych obiekt√≥w. To pomaga zrozumieƒá koncepcjƒô!"
  );
  
  generateVisualMathQuestion();
}

// Generowanie wizualnego pytania matematycznego
function generateVisualMathQuestion() {
  const num1 = Math.floor(Math.random() * 5) + 1;
  const num2 = Math.floor(Math.random() * 5) + 1;
  const answer = num1 * num2;
  
  mathState.currentQuestion = { num1, num2, answer };
  
  // Wizualizacja
  const visualization = document.getElementById('math-visualization');
  visualization.innerHTML = '';
  
  // Pierwsza liczba jako grupy
  const groupsContainer = document.createElement('div');
  groupsContainer.className = 'multiply-group';
  
  for (let i = 0; i < num1; i++) {
    const group = document.createElement('div');
    group.className = 'group-container';
    
    for (let j = 0; j < num2; j++) {
      const element = document.createElement('div');
      element.className = 'math-element';
      
      // R√≥≈ºne kosmiczne ikonki
      const icons = ['üöÄ', 'üõ∏', '‚≠ê', 'ü™ê', '‚òÑÔ∏è', 'üëΩ'];
      element.textContent = icons[Math.floor(Math.random() * icons.length)];
      element.style.background = `hsl(${i * 60}, 70%, 60%)`;
      element.style.animationDelay = `${(i+j)*0.2}s`;
      group.appendChild(element);
    }
    
    groupsContainer.appendChild(group);
  }
  
  visualization.appendChild(groupsContainer);
  
  // Operator
  const operator = document.createElement('div');
  operator.className = 'math-operator';
  operator.textContent = '=';
  visualization.appendChild(operator);
  
  // Wynik (poczƒÖtkowo ukryty)
  const resultContainer = document.createElement('div');
  resultContainer.className = 'multiply-group';
  
  const resultGroup = document.createElement('div');
  resultGroup.className = 'group-container';
  
  for (let i = 0; i < answer; i++) {
    const element = document.createElement('div');
    element.className = 'math-element';
    
    const icons = ['üöÄ', 'üõ∏', '‚≠ê', 'ü™ê', '‚òÑÔ∏è', 'üëΩ'];
    element.textContent = icons[Math.floor(Math.random() * icons.length)];
    element.style.background = `hsl(${i * 10}, 70%, 60%)`;
    element.style.animationDelay = `${i*0.1}s`;
    resultGroup.appendChild(element);
  }
  
  resultContainer.appendChild(resultGroup);
  visualization.appendChild(resultContainer);
  
  // Pytanie
  document.getElementById('math-result-display').textContent = `${num1} √ó ${num2} = ?`;
  
  // Opcje odpowiedzi
  generateMathAnswerOptions(answer, [answer-2, answer+3, answer+5, answer-5]);
}

// Tryb treningu matematycznego
function startPracticeMathMode() {
  showMathMessage(
    "Misja Treningu", 
    "ƒÜwicz mno≈ºenie w r√≥≈ºnych konfiguracjach. Skup siƒô na obszarach, kt√≥re sprawiajƒÖ Ci trudno≈õƒá!"
  );
  
  generatePracticeMathQuestion();
}

// Generowanie pytania treningowego matematycznego
function generatePracticeMathQuestion() {
  const num1 = Math.floor(Math.random() * 10) + 1;
  const num2 = Math.floor(Math.random() * 10) + 1;
  const answer = num1 * num2;
  
  mathState.currentQuestion = { num1, num2, answer };
  
  // Wy≈õwietlenie pytania
  document.getElementById('math-result-display').textContent = `${num1} √ó ${num2} = ?`;
  
  // Wyczy≈õƒá wizualizacjƒô
  document.getElementById('math-visualization').innerHTML = '';
  
  // Generowanie opcji odpowiedzi
  const wrongAnswers = generateMathWrongAnswers(answer, 3);
  generateMathAnswerOptions(answer, wrongAnswers);
}

// Tryb wyzwania matematycznego
function startChallengeMathMode() {
  showMathMessage(
    "Misja Wyzwania", 
    "RozwiƒÖzuj dzia≈Çania przeciwko czasowi! Sprawd≈∫ swojƒÖ szybko≈õƒá i precyzjƒô."
  );
  
  generateChallengeMathQuestion();
}

// Generowanie pytania wyzwania matematycznego
function generateChallengeMathQuestion() {
  const num1 = Math.floor(Math.random() * 10) + 1;
  const num2 = Math.floor(Math.random() * 10) + 1;
  const answer = num1 * num2;
  
  mathState.currentQuestion = { num1, num2, answer };
  
  // Wy≈õwietlenie pytania
  document.getElementById('math-result-display').textContent = `${num1} √ó ${num2} = ?`;
  
  // Wyczy≈õƒá wizualizacjƒô
  document.getElementById('math-visualization').innerHTML = '';
  
  // Generowanie opcji odpowiedzi
  const wrongAnswers = generateMathWrongAnswers(answer, 3);
  generateMathAnswerOptions(answer, wrongAnswers);
}

// Pokazanie tabliczki mno≈ºenia matematycznej
function showMathMultiplyTable() {
  document.getElementById('math-game-screen').classList.add('hidden');
  document.getElementById('math-multiply-table').classList.remove('hidden');
  
  // Pod≈õwietlenie wybranej kolumny/wiersza
  const randomRow = Math.floor(Math.random() * 10) + 1;
  const randomCol = Math.floor(Math.random() * 10) + 1;
  
  document.querySelectorAll('.table-cell').forEach(cell => {
    cell.classList.remove('highlight');
    
    if (cell.dataset.row == randomRow || cell.dataset.col == randomCol) {
      cell.classList.add('highlight');
    }
  });
}

// Tryb opowie≈õci matematycznej
function startStoryMathMode() {
  showMathMessage(
    "Misja Opowie≈õci", 
    "Odkryj kosmiczne historie, w kt√≥rych mno≈ºenie odgrywa kluczowƒÖ rolƒô!"
  );
  
  generateStoryMathQuestion();
}

// Generowanie pytania w trybie historii matematycznej
function generateStoryMathQuestion() {
  const stories = [
    {
      scenario: "Statek kosmiczny 'Gwiezdny Eksplorator' potrzebuje paliwa do podr√≥≈ºy miƒôdzygalaktycznej. Ka≈ºdy z 5 silnik√≥w wymaga 3 kapsu≈Ç specjalnego paliwa. Ile kapsu≈Ç potrzebuje kapitan Zorax, aby wype≈Çniƒá wszystkie zbiorniki?",
      num1: 5,
      num2: 3,
      answer: 15
    },
    {
      scenario: "Na stacji kosmicznej 'Andromeda' mieszka 6 astronaut√≥w. Ka≈ºdy z nich zjada 4 posi≈Çki dziennie, aby utrzymaƒá si≈Çy podczas eksperyment√≥w. Ile posi≈Çk√≥w musi przygotowaƒá sztuczna inteligencja STELLA ka≈ºdego dnia?",
      num1: 6,
      num2: 4,
      answer: 24
    },
    {
      scenario: "Kosmiczny ogr√≥d na planecie Flora ma 8 rzƒôd√≥w magicznych ro≈õlin. W ka≈ºdym rzƒôdzie ro≈õnie 7 ro≈õlin, kt√≥re wytwarzajƒÖ tlen dla kolonii. Ile ro≈õlin jest w ogrodzie?",
      num1: 8,
      num2: 7,
      answer: 56
    },
    {
      scenario: "Podczas misji na ksiƒô≈ºycu Jowisza, Europa, ka≈ºdy z 9 ≈Çazik√≥w zbiera 6 pr√≥bek ska≈Ç dziennie. Ile pr√≥bek zostanie zebranych po jednym dniu eksploracji?",
      num1: 9,
      num2: 6,
      answer: 54
    }
  ];
  
  const story = stories[Math.floor(Math.random() * stories.length)];
  const answer = story.answer;
  
  mathState.currentQuestion = { 
    num1: story.num1, 
    num2: story.num2, 
    answer,
    scenario: story.scenario
  };
  
  // Wy≈õwietlenie scenariusza
  document.getElementById('math-story-text').textContent = story.scenario;
  document.getElementById('math-story-text').classList.remove('hidden');
  document.getElementById('math-result-display').textContent = `Ile to jest ${story.num1} √ó ${story.num2}?`;
  
  // Wyczy≈õƒá wizualizacjƒô
  document.getElementById('math-visualization').innerHTML = '';
  
  // Generowanie opcji odpowiedzi
  const wrongAnswers = generateMathWrongAnswers(answer, 3);
  generateMathAnswerOptions(answer, wrongAnswers);
}

// Generowanie b≈Çƒôdnych odpowiedzi matematycznych
function generateMathWrongAnswers(correct, count) {
  const wrongAnswers = [];
  
  while (wrongAnswers.length < count) {
    const wrong = correct + (Math.floor(Math.random() * 10) - 5);
    if (wrong !== correct && wrong > 0 && !wrongAnswers.includes(wrong)) {
      wrongAnswers.push(wrong);
    }
  }
  
  return wrongAnswers;
}

// Generowanie opcji odpowiedzi matematycznych
function generateMathAnswerOptions(correct, wrongAnswers) {
  const optionsContainer = document.getElementById('math-answer-options');
  optionsContainer.innerHTML = '';
  
  // Po≈ÇƒÖcz poprawne i b≈Çƒôdne odpowiedzi
  const allAnswers = [correct, ...wrongAnswers];
  
  // Pomieszaj kolejno≈õƒá
  for (let i = allAnswers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [allAnswers[i], allAnswers[j]] = [allAnswers[j], allAnswers[i]];
  }
  
  // Utw√≥rz przyciski odpowiedzi
  allAnswers.forEach(answer => {
    const option = document.createElement('div');
    option.className = 'choice';
    option.textContent = answer;
    
    option.addEventListener('click', () => checkMathAnswer(answer, correct, option));
    
    optionsContainer.appendChild(option);
  });
}

// Sprawdzanie odpowiedzi matematycznych
function checkMathAnswer(selected, correct, element) {
  mathState.totalQuestions++;
  mathState.energy = Math.max(0, mathState.energy - 1);
  
  if (selected === correct) {
    // Poprawna odpowied≈∫
    element.classList.add('correct');
    mathState.correctAnswers++;
    mathState.streak++;
    mathState.points += 10 * mathState.streak;
    
    // Aktualizacja statystyk
    updateMathStats();
    
    // Sprawd≈∫ osiƒÖgniƒôcia
    checkMathAchievements();
    
    // Animacja sukcesu
    createConfetti();
    
    // Komunikat
    showMathMessage("Dobrze!", `Poprawna odpowied≈∫! ${mathState.streak} poprawnych z rzƒôdu!`);
  } else {
    // B≈Çƒôdna odpowied≈∫
    element.classList.add('incorrect');
    mathState.streak = 0;
    
    // Poka≈º poprawnƒÖ odpowied≈∫
    document.querySelectorAll('#math-answer-options .choice').forEach(opt => {
      if (parseInt(opt.textContent) === correct) {
        opt.classList.add('correct');
      }
    });
    
    showMathMessage("Spr√≥buj ponownie", `Poprawna odpowied≈∫ to ${correct}.`);
  }
  
  // Zablokuj przyciski po udzieleniu odpowiedzi
  document.querySelectorAll('#math-answer-options .choice').forEach(opt => {
    opt.style.pointerEvents = 'none';
  });
}

// Aktualizacja statystyk matematycznych
function updateMathStats() {
  document.getElementById('math-points').textContent = mathState.points;
  document.getElementById('math-energy').textContent = mathState.energy;
  
  // Aktualizacja paska postƒôpu
  const progress = (mathState.correctAnswers / Math.max(1, mathState.totalQuestions)) * 100;
  document.getElementById('math-progress-bar').style.width = `${progress}%`;
  
  // Aktualizacja poziomu
  const newLevel = Math.floor(mathState.correctAnswers / 10) + 1;
  if (newLevel > mathState.level) {
    mathState.level = newLevel;
    document.getElementById('math-level').textContent = mathState.level;
    showMathMessage("Awans!", `OsiƒÖgnƒÖ≈Çe≈õ poziom ${mathState.level}!`);
    createConfetti();
  }
}

// Sprawdzanie osiƒÖgniƒôƒá matematycznych
function checkMathAchievements() {
  const achievements = [
    { id: 'first', count: 5 },
    { id: 'streak', count: 10 },
    { id: 'master', count: 50 },
    { id: 'genius', count: 100 }
  ];
  
  achievements.forEach(ach => {
    if (mathState.correctAnswers >= ach.count && !mathState.achievements.includes(ach.id)) {
      mathState.achievements.push(ach.id);
      document.getElementById(`math-ach-${ach.id}`).classList.add('unlocked');
      showMathMessage("OsiƒÖgniƒôcie odblokowane!", `Zdoby≈Çe≈õ osiƒÖgniƒôcie za ${ach.count} poprawnych odpowiedzi!`);
      createConfetti();
    }
  });
}

// Tworzenie konfetti
function createConfetti() {
  const celebration = document.getElementById('celebration');
  celebration.innerHTML = '';
  
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = `${Math.random() * 100}%`;
    confetti.style.background = `hsl(${Math.random() * 360}, 70%, 60%)`;
    confetti.style.animationDelay = `${Math.random() * 2}s`;
    celebration.appendChild(confetti);
  }
  
  setTimeout(() => {
    celebration.innerHTML = '';
  }, 5000);
}

// Wy≈õwietlanie wiadomo≈õci matematycznych
function showMathMessage(title, description) {
  document.getElementById('math-game-title').textContent = title;
  document.getElementById('math-game-description').textContent = description;
}

// Pomocnicza funkcja do przyciemniania koloru
function darkenColor(color, percent) {
  const num = parseInt(color.replace("#", ""), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) - amt;
  const G = (num >> 8 & 0x00FF) - amt;
  const B = (num & 0x0000FF) - amt;
  
  return "#" + (
    0x1000000 + 
    (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
    (B < 255 ? B < 1 ? 0 : B : 255)
  ).toString(16).slice(1);
}

// Ustawienie nas≈Çuchiwaczy zdarze≈Ñ matematycznych
document.getElementById('math-next-btn').addEventListener('click', () => {
  if (mathState.currentPlanet) {
    switch(mathState.currentPlanet) {
      case 'visual':
        generateVisualMathQuestion();
        break;
      case 'practice':
        generatePracticeMathQuestion();
        break;
      case 'challenge':
        generateChallengeMathQuestion();
        break;
      case 'story':
        generateStoryMathQuestion();
        break;
    }
    
    // Odblokuj przyciski odpowiedzi
    document.querySelectorAll('#math-answer-options .choice').forEach(opt => {
      opt.style.pointerEvents = 'auto';
      opt.classList.remove('correct', 'incorrect');
    });
  }
});

document.getElementById('math-hint-btn').addEventListener('click', () => {
  if (mathState.currentQuestion) {
    showMathMessage("Podpowied≈∫", `Spr√≥buj obliczyƒá ${mathState.currentQuestion.num1} + ${mathState.currentQuestion.num1} + ... (${mathState.currentQuestion.num2} razy)`);
  }
});

document.getElementById('math-reset-btn').addEventListener('click', () => {
  mathState.correctAnswers = 0;
  mathState.totalQuestions = 0;
  mathState.streak = 0;
  mathState.points = 0;
  mathState.energy = 100;
  mathState.level = 1;
  updateMathStats();
  showMathMessage("Zresetowano postƒôp", "Tw√≥j postƒôp zosta≈Ç zresetowany. Zacznij od nowa!");
});

// === INICJALIZACJA CA≈ÅO≈öCI ===
document.addEventListener('DOMContentLoaded', function() {
  createStars();
  createCosmicBackground();
  
  // Inicjalizacja angielskiego
  if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = initVoices;
    setTimeout(initVoices, 0);
  }
  
  // Inicjalizacja matematyki
  generatePlanets();
  generateMathAchievements();
  generateMultiplyTable();
  
  // PoczƒÖtkowa wiadomo≈õƒá matematyczna
  showMathMessage(
    "Witaj, Kosmiczny Podr√≥≈ºniku z Klasy 2B!", 
    "Twoja misja to opanowanie tabliczki mno≈ºenia! Wybierz misjƒô, aby rozpoczƒÖƒá trening."
  );
});
</script>
</body>
</html>
