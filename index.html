<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KidsCan! 2 â€” Trener sÅ‚Ã³wek KLASA 2B</title>
  <style>
    :root{
      --bg:#fff8f0; --card:#ffffff; --ink:#1b1b1b; --muted:#666; --accent:#6c5ce7; --accent2:#00b894; --wrong:#ff7675; --right:#55efc4;
    }
    html,body{height:100%;}
    body{margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", sans-serif; background:var(--bg); color:var(--ink);}    
    .app{max-width:1100px; margin:0 auto; padding:16px 16px 28px;}
    .header{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .title{display:flex; align-items:center; gap:10px;}
    .title h1{margin:0; font-size:clamp(22px, 3vw, 32px);}    
    .title .badge{background:var(--accent); color:white; padding:6px 10px; border-radius:999px; font-weight:700; font-size:14px;}
    .panel{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media(min-width:900px){
      .panel{grid-template-columns: 340px 1fr;}
    }
    .card{background:var(--card); border-radius:18px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.06);}    
    .section-title{font-weight:800; margin:4px 0 10px; font-size:18px;}
    .row{display:flex; flex-wrap:wrap; gap:8px;}
    .select, select{width:100%; padding:12px 14px; border-radius:12px; border:2px solid #eee; font-size:16px;}
    .chip{display:inline-flex; align-items:center; gap:8px; background:#f3f4f6; border:2px solid #e5e7eb; padding:10px 12px; border-radius:14px; cursor:pointer; user-select:none; font-weight:700;}
    .chip input{display:none}
    .chip.active{background:#eaf7ff; border-color:#b6e3ff}
    .mode{display:grid; grid-template-columns:repeat(2,1fr); gap:8px;}
    .mode .chip{justify-content:center}
    .btn{appearance:none; border:none; padding:14px 16px; font-weight:900; border-radius:16px; cursor:pointer; font-size:16px;}
    .btn-primary{background:var(--accent); color:white;}
    .btn-secondary{background:#ffeaa7;}
    .btn-ghost{background:#f3f4f6;}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .quiz{display:grid; gap:12px;}
    .prompt{font-size:clamp(22px,2.6vw,30px); font-weight:900;}
    .choices{display:grid; gap:8px; grid-template-columns:1fr;}
    @media(min-width:700px){.choices{grid-template-columns:repeat(2,1fr);} }
    .choice{padding:14px; border-radius:14px; border:2px solid #eee; background:white; font-size:18px; text-align:center; cursor:pointer;}
    .choice:hover{transform:translateY(-1px);}
    .choice.correct{border-color:var(--right); background:#ecfff9}
    .choice.wrong{border-color:var(--wrong); background:#fff1f1}
    .progress{display:flex; align-items:center; gap:8px; font-weight:700;}
    .bar{flex:1; height:10px; background:#eee; border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2));}
    .tiny{color:var(--muted); font-size:12px;}

    .flex{display:flex; gap:8px; align-items:center}

    .pill{border-radius:999px; background:#f3f4f6; padding:6px 10px; font-weight:800;}

    .flashcard{display:grid; place-items:center; height:240px; border-radius:18px; border:2px dashed #e5e7eb; background:white; cursor:pointer; perspective:1000px;}
    .flash-inner{position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform .5s ease; display:grid; place-items:center;}
    .flash-inner.flipped{transform:rotateY(180deg)}
    .face{position:absolute; inset:0; backface-visibility:hidden; display:grid; place-items:center; font-size:28px; font-weight:900; padding:18px;}
    .back{transform:rotateY(180deg)}

    .sound-btn{background:#e8f5ff; border-radius:999px; padding:10px 12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; font-weight:800;}

    .footer{margin-top:14px; color:#666; font-size:12px;}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">
         <h1>Klasa 2B  Trener sÅ‚Ã³wek</h1>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <label class="pill">JÄ™zyk:</label>
        <select id="langSelect" class="select" style="width:180px;">
          <option value="en">English (EN)</option>
          <option value="de">Deutsch (DE)</option>
        </select>
      </div>
    </div>

    <div class="panel">
      <aside class="card">
        <div class="section-title">1) Wybierz rozdziaÅ‚</div>
        <select id="chapterSelect" class="select"></select>

        <div class="section-title">2) Zakres sÅ‚ownictwa</div>
        <div class="row" id="scopeRow">
          <label class="chip"><input type="radio" name="scope" value="basic" checked/> Podstawowe ğŸŒ±</label>
          <label class="chip"><input type="radio" name="scope" value="extended"/> Rozszerzone ğŸŒ¿</label>
          <label class="chip"><input type="radio" name="scope" value="both"/> Oba âœ…</label>
        </div>

        <div class="section-title">3) Tryb nauki</div>
        <div class="mode" id="modeRow">
          <label class="chip"><input type="radio" name="mode" value="en2pl"/> L1 â†’ PL</label>
          <label class="chip"><input type="radio" name="mode" value="pl2en"/> PL â†’ L1</label>
          <label class="chip"><input type="radio" name="mode" value="spelling"/> Pisownia (L1 âœï¸)</label>
          <label class="chip active"><input type="radio" name="mode" value="mix" checked/> MIX (domyÅ›lnie)</label>
        </div>

        <div class="section-title">4) Dodatkowe opcje</div>
        <div class="row">
          <button class="btn btn-ghost" id="btnTTSl1" title="OdsÅ‚uchaj w jÄ™zyku L1">ğŸ”Š L1</button>
          <button class="btn btn-ghost" id="btnTTSpl" title="OdsÅ‚uchaj po polsku">ğŸ”Š PL</button>
          <button class="btn btn-secondary" id="btnFlash">ğŸƒ Tryb fiszek</button>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn btn-primary" id="btnStart">â–¶ï¸ Start testu</button>
          <button class="btn" id="btnReset">ğŸ”„ Reset</button>
        </div>
      </aside>

      <main class="card">
        <div id="quizView" class="quiz">
          <div class="progress"><div class="bar"><i id="barFill"></i></div><span id="counter">0/0</span></div>
          <div class="prompt" id="prompt">Wybierz jÄ™zyk i rozdziaÅ‚, potem kliknij Start testu.</div>
          <div class="row">
            <span class="sound-btn" id="speakPrompt">ğŸ”Š Przeczytaj</span>
          </div>
          <div id="choices" class="choices"></div>
          <div id="spellingBox" style="display:none" class="row">
            <input id="spellingInput" class="select" placeholder="Wpiszâ€¦"/>
            <button class="btn btn-primary" id="checkSpell">SprawdÅº</button>
          </div>
          <div class="row">
            <button class="btn btn-secondary" id="btnNext" disabled>NastÄ™pne â¡ï¸</button>
          </div>
          <div class="tiny" id="feedback"></div>
        </div>

        <div id="flashView" style="display:none">
          <div class="progress"><div class="bar"><i id="barFillFlash"></i></div><span id="counterFlash">0/0</span></div>
          <div class="flashcard" id="flashcard" title="Kliknij, aby obrÃ³ciÄ‡">
            <div class="flash-inner" id="flashInner">
              <div class="face front" id="flashFront">ğŸ˜º</div>
              <div class="face back" id="flashBack">â€”</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn btn-ghost" id="speakFront">ğŸ”Š PrzÃ³d</button>
            <button class="btn btn-ghost" id="speakBack">ğŸ”Š TyÅ‚</button>
            <button class="btn btn-secondary" id="markHard">ğŸ™ˆ Jeszcze</button>
            <button class="btn btn-primary" id="markEasy">ğŸ˜º Umiem</button>
          </div>
        </div>
      </main>
    </div>

    <div class="footer"> Andrzej & Marcin Dane sÅ‚ownictwa na podstawie planu â€Kids Can! 2â€ (rozdziaÅ‚y i zakres podstawowy/rozszerzony). Projekt edukacyjny â€” uÅ¼ytek wÅ‚asny w klasie/szkole. </div>
  </div>

<script>
// === Dane sÅ‚ownictwa â€” ROZDZIAÅY (EN) ===
const DATA = {
  "WstÄ™pny": {
    basic: [
      {en:"alphabet", pl:"alfabet"}, {en:"count to 20", pl:"liczyÄ‡ do 20"},
      {en:"days of the week", pl:"dni tygodnia"},
      {en:"cloudy", pl:"pochmurno"}, {en:"cold", pl:"zimno"}, {en:"hot", pl:"gorÄ…co"}, {en:"rainy", pl:"deszczowo"}, {en:"sunny", pl:"sÅ‚onecznie"}, {en:"windy", pl:"wietrznie"}
    ],
    extended: [
      {en:"What's your name?", pl:"Jak masz na imiÄ™?"}, {en:"How old are you?", pl:"Ile masz lat?"},
      {en:"My favourite day isâ€¦", pl:"MÃ³j ulubiony dzieÅ„ toâ€¦"}
    ]
  },
  "1. School": { basic:[{en:"classroom",pl:"klasa"},{en:"computer room",pl:"pracownia komputerowa"},{en:"corridor",pl:"korytarz"},{en:"dining room",pl:"stoÅ‚Ã³wka"},{en:"gym",pl:"sala gimnastyczna"},{en:"library",pl:"biblioteka"},{en:"playground",pl:"plac zabaw"},{en:"toilet",pl:"toaleta"},{en:"behind",pl:"za"},{en:"between",pl:"miÄ™dzy"},{en:"in front of",pl:"przed"},{en:"next to",pl:"obok"}], extended: [] },
  "2. House": { basic:[{en:"attic",pl:"strych"},{en:"bathroom",pl:"Å‚azienka"},{en:"bedroom",pl:"sypialnia"},{en:"garage",pl:"garaÅ¼"},{en:"garden",pl:"ogrÃ³d"},{en:"hall",pl:"hol/przedpokÃ³j"},{en:"kitchen",pl:"kuchnia"},{en:"living room",pl:"salon"}], extended: [] },
  "3. Clothes": { basic:[{en:"dress",pl:"sukienka"},{en:"jacket",pl:"kurtka"},{en:"jeans",pl:"dÅ¼insy"},{en:"skirt",pl:"spÃ³dnica"},{en:"sweater",pl:"sweter"},{en:"trainers",pl:"trampki"},{en:"trousers",pl:"spodnie"},{en:"T-shirt",pl:"koszulka"}], extended: [] },
  "4. Appearance": { basic:[{en:"beard",pl:"broda"},{en:"curly hair",pl:"krÄ™cone wÅ‚osy"},{en:"dark hair",pl:"ciemne wÅ‚osy"},{en:"fair hair",pl:"jasne wÅ‚osy"}], extended: [] },
  "5. Camp & Free time": { basic:[{en:"climb a tree",pl:"wspinaÄ‡ siÄ™ na drzewo"},{en:"do yoga",pl:"Ä‡wiczyÄ‡ jogÄ™"}], extended: [] },
  "6. Summer & City": { basic:[{en:"aquarium",pl:"akwarium"},{en:"beach",pl:"plaÅ¼a"}], extended: [] }
};

// === Dane sÅ‚ownictwa â€” ROZDZIAÅY (DE) ===
// Dodany rozdziaÅ‚ na podstawie Twoich danych: "Das trinke ich gern (Str. 29)"
const DATA_DE = {
  "Das trinke ich gern (Str. 29)": {
    basic: [
      // peÅ‚ne zdania (zwroty)
      {l1:"Ich trinke gern Milch.", pl:"ChÄ™tnie pijÄ™ mleko.", word:"Milch"},
      {l1:"Ich trinke gern Apfelsaft.", pl:"ChÄ™tnie pijÄ™ sok jabÅ‚kowy.", word:"Apfelsaft"},
      {l1:"Ich trinke gern Limo.", pl:"ChÄ™tnie pijÄ™ lemoniadÄ™.", word:"Limo"},
      {l1:"Ich trinke gern Cola.", pl:"ChÄ™tnie pijÄ™ colÄ™.", word:"Cola"},
      {l1:"Ich trinke gern Tee.", pl:"ChÄ™tnie pijÄ™ herbatÄ™.", word:"Tee"},
      {l1:"Ich trinke gern Kakao.", pl:"ChÄ™tnie pijÄ™ kakao.", word:"Kakao"},
      {l1:"Ich trinke gern Mineralwasser.", pl:"ChÄ™tnie pijÄ™ wodÄ™ mineralnÄ….", word:"Mineralwasser"},
      // pojedyncze sÅ‚Ã³wka
      {l1:"Milch", pl:"mleko"}, {l1:"Apfelsaft", pl:"sok jabÅ‚kowy"}, {l1:"Limo", pl:"lemoniada"}, {l1:"Cola", pl:"cola"}, {l1:"Tee", pl:"herbata"}, {l1:"Kakao", pl:"kakao"}, {l1:"Mineralwasser", pl:"woda mineralna"}
    ],
    extended: []
  }
};

// === Stan aplikacji ===
let queue = []; // kolejka pytaÅ„
let current = null; // bieÅ¼Ä…ce pytanie {q, a,choices, qLang:'l1'|'pl', type:'choice'|'spelling', item}
let answered = 0, correct = 0;
let wrongStack = []; // bÅ‚Ä™dne odpowiedzi do powtÃ³rki
let mode = 'mix';
let voiceEN = null, voiceDE = null, voicePL = null;
let currentLang = 'en'; // 'en' or 'de'
let flashIndex = 0; let flashItems = [];

// === Inicjalizacja DOM ===
const langSelect = document.getElementById('langSelect');
const chapterSelect = document.getElementById('chapterSelect');

function populateChapters(){
  chapterSelect.innerHTML = '';
  const src = currentLang === 'en' ? DATA : DATA_DE;
  Object.keys(src).forEach((name, idx)=>{
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name; if(idx===0) opt.selected=true; chapterSelect.appendChild(opt);
  });
}

populateChapters();

// radio chips UI
function syncChips(containerId){
  const el = document.getElementById(containerId);
  el.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      el.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      const input = ch.querySelector('input'); input.checked = true;
      if(containerId==='modeRow'){ mode = input.value; document.getElementById('spellingBox').style.display = (mode==='spelling')?'grid':'none'; }
    });
  });
}

syncChips('scopeRow');
syncChips('modeRow');

// === TTS ===
function initVoices() {
  const voices = window.speechSynthesis.getVoices();
  voiceEN = voices.find(v => v.lang && v.lang.startsWith('en-')) || voices.find(v => v.lang && v.lang.toLowerCase().includes('en')) || voices[0];
  voiceDE = voices.find(v => v.lang && v.lang.startsWith('de-')) || voices.find(v => v.lang && v.lang.toLowerCase().includes('de')) || voices[0];
  voicePL = voices.find(v => v.lang && v.lang.startsWith('pl-')) || voices.find(v => v.lang && v.lang.toLowerCase().includes('pol')) || voices[0];
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = initVoices;
  initVoices();
}

function speakText(text, lang){
  if(!text) return;
  const u = new SpeechSynthesisUtterance(text);
  if(lang==='en') u.voice = voiceEN;
  else if(lang==='de') u.voice = voiceDE;
  else if(lang==='pl') u.voice = voicePL;
  u.rate = 0.95; u.pitch = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

// przyciski odsÅ‚uchu
document.getElementById('btnTTSl1').onclick = () =>
  current ? speakText(current.qLang === 'l1' ? current.q : current.a, currentLang) : null;

document.getElementById('btnTTSpl').onclick = () =>
  current ? speakText(current.qLang === 'l1' ? current.a : current.q, 'pl') : null;

document.getElementById('speakPrompt').onclick = () =>
  current ? (current.qLang === 'l1' ? speakText(current.q, currentLang) : speakText(current.q, 'pl')) : null;

// === Losowanie pytaÅ„ ===
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

function buildPool(){
  const chapter = chapterSelect.value;
  const scope = document.querySelector('input[name="scope"]:checked').value; // basic|extended|both
  let pool = [];
  const src = currentLang === 'en' ? DATA[chapter] : DATA_DE[chapter];
  if(!src) return [];
  if(scope==='basic' || scope==='both') pool = pool.concat(src.basic);
  if(scope==='extended' || scope==='both') pool = pool.concat(src.extended);
  return pool;
}

function makeQuestion(item){
  // Based on mode & language, generate question object
  const rawMode = mode==='mix' ? ['en2pl','pl2en','spelling'][Math.floor(Math.random()*3)] : mode;
  // Map to actual directional mode depending on language
  let m = rawMode;
  if(currentLang==='de'){
    if(rawMode==='en2pl') m = 'l1toPl';
    if(rawMode==='pl2en') m = 'plToL1';
  } else {
    if(rawMode==='en2pl') m = 'l1toPl';
    if(rawMode==='pl2en') m = 'plToL1';
  }
  if(m==='spelling'){
    // spelling in L1 (en/de) â€” show prompt in Polish, expect L1
    if(currentLang==='en') return {q:item.en, a:item.en, qLang:'l1', type:'spelling', item};
    else return {q:item.l1 || item.en, a:item.l1 || item.en, qLang:'l1', type:'spelling', item};
  }

  // choice question
  const pool = buildPool();
  if(currentLang==='en'){
    if(m==='l1toPl'){
      const distractors = shuffle(pool.filter(x=>x!==item)).slice(0,3).map(x=>x.pl);
      return {q:item.en, a:item.pl, qLang:'l1', type:'choice', choices:shuffle([item.pl, ...distractors]), item};
    } else {
      const distractors = shuffle(pool.filter(x=>x!==item)).slice(0,3).map(x=>x.en);
      return {q:item.pl, a:item.en, qLang:'pl', type:'choice', choices:shuffle([item.en, ...distractors]), item};
    }
  } else { // german
    if(m==='l1toPl'){
      // present German (l1) -> Polish
      const distractors = shuffle(pool.filter(x=>x!==item)).slice(0,3).map(x=>x.pl);
      const qText = item.l1 || item.en || '';
      const aText = item.pl || '';
      return {q:qText, a:aText, qLang:'l1', type:'choice', choices:shuffle([aText, ...distractors]), item};
    } else {
      // Polish -> German (l1)
      const distractors = shuffle(pool.filter(x=>x!==item)).slice(0,3).map(x=>x.l1 || x.en);
      const qText = item.pl || '';
      const aText = item.l1 || item.en || '';
      return {q:qText, a:aText, qLang:'pl', type:'choice', choices:shuffle([aText, ...distractors]), item};
    }
  }
}

function startQuiz(){
  queue = shuffle(buildPool().slice());
  answered = 0; correct = 0; wrongStack = [];
  document.getElementById('feedback').textContent='';
  nextQuestion();
}

function nextQuestion(){
  document.getElementById('btnNext').disabled = true;
  document.getElementById('spellingInput').value='';
  const progressBar = document.getElementById('barFill');
  const counter = document.getElementById('counter');
  const totalPool = answered + queue.length + wrongStack.length;
  if(queue.length===0){
    if(wrongStack.length){ // powtÃ³rka
      queue = shuffle(wrongStack.slice()); wrongStack = [];
      document.getElementById('feedback').innerHTML = 'ğŸ” PowtÃ³rka z bÅ‚Ä™dÃ³w! Dobra robota, dziaÅ‚amy dalej.';
    } else {
      document.getElementById('prompt').textContent = `Koniec! âœ… Poprawnych: ${correct}`;
      document.getElementById('choices').innerHTML='';
      document.getElementById('spellingBox').style.display = (mode==='spelling')?'grid':'none';
      progressBar.style.width = '100%'; counter.textContent = 'âœ”ï¸';
      current = null; return;
    }
  }
  const item = queue.shift();
  current = makeQuestion(item);
  renderQuestion(current);
  const denom = Math.max(1, totalPool);
  progressBar.style.width = `${(answered/denom)*100}%`;
  counter.textContent = `${answered}/${denom}`;
}

function renderQuestion(q){
  const prompt = document.getElementById('prompt');
  const choices = document.getElementById('choices');
  const sb = document.getElementById('spellingBox');
  const feedback = document.getElementById('feedback');
  feedback.textContent = '';

  if(!q) return;

  if(q.type==='choice'){
    sb.style.display = 'none';
    choices.innerHTML = '';
    prompt.textContent = q.q;
    q.choices.forEach(txt=>{
      const btn = document.createElement('button');
      btn.className = 'choice'; btn.textContent = txt;
      btn.onclick = ()=> selectChoice(btn, txt===q.a);
      choices.appendChild(btn);
    });
  } else { // spelling
    choices.innerHTML = '';
    sb.style.display = 'grid';
    // show Polish prompt asking to write L1
    if(currentLang==='en') prompt.textContent = `Napisz po angielsku: ${q.item.pl}`;
    else prompt.textContent = `Napisz po niemiecku: ${q.item.pl}`;
  }
}

function selectChoice(el, ok){
  const all = Array.from(document.querySelectorAll('.choice'));
  all.forEach(b=>b.disabled=true);
  el.classList.add(ok?'correct':'wrong');
  if(!ok){
    // zaznacz poprawnÄ…
    const correctBtn = all.find(b=>b.textContent===current.a);
    if(correctBtn) correctBtn.classList.add('correct');
    // push underlying item for repeat
    wrongStack.push(current.item);
  } else { correct++; }
  answered++;
  document.getElementById('btnNext').disabled = false;
}

// Spelling check
function norm(s){ return s.trim().toLowerCase().replace(/\s+/g,' '); }
function checkSpelling(){
  const val = document.getElementById('spellingInput').value;
  const fb = document.getElementById('feedback');
  if(!val) return;
  const ok = norm(val)===norm(current.a);
  if(ok){ fb.textContent = 'âœ… Super!'; correct++; } else { fb.textContent = `âŒ Powinno byÄ‡: "${current.a}"`; wrongStack.push(current.item); }
  answered++; document.getElementById('btnNext').disabled = false;
}

document.getElementById('checkSpell').onclick = checkSpelling;
document.getElementById('spellingInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ checkSpelling(); }});

document.getElementById('btnNext').onclick = nextQuestion;
document.getElementById('btnStart').onclick = startQuiz;
document.getElementById('btnReset').onclick = ()=>{ queue=[]; wrongStack=[]; answered=0; correct=0; current=null; document.getElementById('prompt').textContent='Wybierz jÄ™zyk i rozdziaÅ‚, potem kliknij Start testu.'; document.getElementById('choices').innerHTML=''; document.getElementById('counter').textContent='0/0'; document.getElementById('barFill').style.width='0%'; };

// === Tryb fiszek ===
const flashView = document.getElementById('flashView');
const quizView = document.getElementById('quizView');

document.getElementById('btnFlash').onclick = ()=>{
  if(flashView.style.display==='none'){ enterFlash(); } else { exitFlash(); }
};

function enterFlash(){
  flashItems = shuffle(buildPool().slice());
  flashIndex = 0; renderFlash();
  quizView.style.display='none'; flashView.style.display='block';
}
function exitFlash(){ quizView.style.display='grid'; flashView.style.display='none'; }

function renderFlash(){
  const total = flashItems.length; const cur = flashItems[flashIndex] || {en:'â€”', pl:'â€”'};
  if(currentLang==='en'){
    document.getElementById('flashFront').textContent = cur.en;
    document.getElementById('flashBack').textContent = cur.pl;
  } else {
    document.getElementById('flashFront').textContent = cur.l1 || cur.en || 'â€”';
    document.getElementById('flashBack').textContent = cur.pl || 'â€”';
  }
  document.getElementById('barFillFlash').style.width = `${(flashIndex/Math.max(1,total))*100}%`;
  document.getElementById('counterFlash').textContent = `${flashIndex+1}/${total}`;
  document.getElementById('flashInner').classList.remove('flipped');
}

document.getElementById('flashcard').onclick = ()=>{ document.getElementById('flashInner').classList.toggle('flipped'); };

document.getElementById('markEasy').onclick = ()=>{ if(flashIndex < flashItems.length-1){ flashIndex++; renderFlash(); } };

document.getElementById('markHard').onclick = ()=>{
  const it = flashItems[flashIndex]; flashItems.push(it);
  flashIndex++; renderFlash();
};

document.getElementById('speakFront').onclick = ()=>{ const it=flashItems[flashIndex]; if(currentLang==='en') speakText(it.en,'en'); else speakText(it.l1 || it.en,'de'); };

document.getElementById('speakBack').onclick = ()=>{ const it=flashItems[flashIndex]; speakText(it.pl,'pl'); };

// Language change handler
langSelect.addEventListener('change', ()=>{
  currentLang = langSelect.value;
  populateChapters();
  // reset state
  queue=[]; wrongStack=[]; answered=0; correct=0; current=null;
  document.getElementById('prompt').textContent='Wybierz rozdziaÅ‚ i kliknij Start testu.';
  document.getElementById('choices').innerHTML='';
  document.getElementById('barFill').style.width='0%';
});

// When chapter changes while in flash mode, re-render
chapterSelect.addEventListener('change', ()=>{ if(flashView.style.display!=='none') renderFlash(); });

// Prefetch voices â€” inicjalizacja
if(window.speechSynthesis){
  window.speechSynthesis.onvoiceschanged = initVoices;
  window.speechSynthesis.getVoices();
  setTimeout(initVoices, 0);
}

</script>
</body>
</html>
